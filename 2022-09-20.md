금일 TIL은 이슈 작성한 것으로 대체
지난주 금요일(16일)에 해결한 이슈다.

## **9월 13일**

Bug : `ffmpeg` 영상 병합(concatenate) 시 에러 발생
MVP를 앞두고, 프론트 서버와 연결하기 전에 마지막으로 테스트를 해보는 중 비디오 병합 기능에서 갑작스러운 에러가 발생했다.

- 기능 구현 이래로 영상은 늘 병합이 잘 됐는데, 이번 테스트에서 처음으로 마지막 3번째 영상에서 병합이 되지 않았다.
- @phenomenonlee님과 데모 영상을 찍어 공유했고 병합이 되는 영상과 되지 않는 영상의 차이를 구분했다.
- 이 과정에서 우리는 병합이 되는 영상과 그렇지 않은 영상의 차이가 **`Dolby Vision`** 란 걸 알게 됐고, **`Dolby Vision`** 이더라도 같은 **`Dolby Vision`** 끼리는 영상 병합이 되는 것을 확인했다.
- 따라서, 병합하고자 하는 영상의 형식이 하나라도 다른 경우 병합이 되지 않는다고 추론할 수 있었다.

  <br>

<details>
<summary>이미지 열기</summary>
<div markdown="1">
<img src="https://user-images.githubusercontent.com/99732695/191316383-8d49c298-cdfd-44d8-81ec-e06d1ba072c4.png" width=400px>
<img src="https://user-images.githubusercontent.com/99732695/191316395-a0125358-ed9d-4da4-9199-6ca0f775d546.png" width=400px>
</div>
</details>

추론을 바탕으로 우리가 실행할 수 있는 방법은 2가지로 보였다.

먼저 업로드 된 영상을 console.log()로 확인하여 어떤 속성이 `Dolby Vision` 을 나타내는지 차이점을 찾아낸 뒤,

1. `Dolby Vision`인 영상은 예외로 처리한다.
   - `Dolby Vision` 은 아이폰 기준 2020년 10월 아이폰12 출시 이후에 탑재한 기능이라 인코딩을 하려면 다운그레이드를 해야 한다는 단점이 있기 때문에, 이는 비효율적이라 판단하여 예외 처리로 진행하고자 했다.
   - 즉, 유저가 같은 형식의 비디오를 업로드 할 수 있게 하고자 했다.
2. 제 3의 형식으로 비디오 3개를 모두 인코딩을 해준다.
   - 영상 3가지 중, 2가지가 같은 형식의 영상이어도 마지막 하나가 다르다면 발생하는 에러였기 때문에 모든 영상을 인코딩하는 건 속도 측면에서도 그렇고 여러 지점에서 서버 자원의 낭비라는 의견을 나누었다.
   - 따라서 제일 후순위로 미뤄놓았다.
3. 백엔드는 아니지만, 1의 과정을 프론트에서 예외를 처리해줄 수 있는지 한 번 논의를 해보잔 의견을 나눴다.

---

먼저 영상의 형식을 확인하기 위해 구글링을 통해 알게 된 라이브러리 `ffprobe` 를 설치했다.

> `ffprobe` :
> 멀티미디어 스트림 분석기로, 영상의 속성이나 정보를 분석할 수 있는 라이브러리

하지만 `ffprobe`를 이용해 console.log(req.file)로 확인한 영상의 속성에서 유의미한 결과를 찾지는 못했다.

- 영상의 길이(size) 말고는 차이점이 보이지 않았다.
- 상단 객체 - Dolby / 하단 객체 - Dolby가 아닌 영상

<img src="https://user-images.githubusercontent.com/99732695/191316693-0ddca1d8-d121-41e9-9808-79213f9ae038.png">

---

이 과정에서 우리는 앞서 계속 언급한 ‘영상의 속성’이 무엇이고 정확하게 어떤 단어로 명시되어 있는지 찾아볼 필요성을 느꼈다.

- 게더 화면 공유 중, 같은 영상을 윈도우 플레이어를 사용하는 팀원은 재생이 되지 않았지만 팟플레이어를 이용하는 팀원은 재생이 되는 것을 보고 **영상 코덱**을 기준으로 삼기로 했다.
- 하지만 역시 코덱을 포함해 유의미한 결과는 얻지 못했다. 다단 기준 왼쪽이 비디오, 오른쪽이 오디오인데 차이가 거의 없었다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/0b1e6544-fd2f-42dd-ae6f-4f18b953ba3e/Untitled.png)

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/8f3bf077-d33f-4476-a1d2-93e6d97fd21d/Untitled.png)

병합되지 않는 영상과 병합되는 영상에는 어떠한 차이가 있을 거라고 생각했는데 결국 차이는 발견할 수 없었다.

- 게다가 테스트를 위해 새로 촬영한 영상들마저 병합이 되지 않았다.
  - 같은 시간, 같은 장소, 같은 세팅으로 촬영한 영상끼리 병합이 되지 않는 현상을 발견

---

<details>
<summary>슬랙에 남겼던 질문과 답변</summary>
<div>
<img src="https://user-images.githubusercontent.com/99732695/190675240-0356b02b-a18e-4870-aa29-4248ad7c3d87.png" width=70%>
<img src="https://user-images.githubusercontent.com/99732695/190679550-829bd125-ff5e-41a2-8132-56742501a36b.png" width=50%>
</div>
</details>

해결까지는 아니지만, 위의 질의응답으로 대안책을 찾을 수 있었다. ffmpeg와 ffmpeg-concat을 기반으로 한 `editly`란 라이브러리로 너무나 간단히 해결했다.

`editly` 는 가장 최신 버전이 현재(9/21) 기준 23일 전에 업데이트 된 최신 라이브러리다. 일종의 확장팩 개념으로 이해했다. 구글링으로는 정보가 찾기가 쉽지 않았고, 대부분의 정보는 공식 깃허브에서 얻을 수 있었다.

기능 자체는 현재 다시 구현이 되어서 프로젝트를 진행 중이다. 하지만 근본적인 해결이 아니어서 아쉬움이 남는다.
